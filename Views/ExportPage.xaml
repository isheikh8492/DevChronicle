<Page
    x:Class="DevChronicle.Views.ExportPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:services="clr-namespace:DevChronicle.Services"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:vm="clr-namespace:DevChronicle.ViewModels"
    Title="Export"
    Foreground="{DynamicResource TextFillColorPrimaryBrush}">

    <Page.Resources>
        <DataTemplate x:Key="HubTemplate">
            <StackPanel>
                <Border
                    Margin="0,0,0,16"
                    Padding="20"
                    Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="10">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="12" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock
                                FontSize="14"
                                FontWeight="SemiBold"
                                Text="Export Hub" />
                            <TextBlock
                                FontSize="12"
                                Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                Text="Select sessions for new exports, or update an existing managed diary." />
                        </StackPanel>

                        <ui:Button
                            Grid.Column="1"
                            Padding="12,6"
                            Appearance="Primary"
                            Command="{Binding GoToNewTargetCommand}"
                            Content="Create New Export..."
                            IsEnabled="{Binding CanCreateNewExport}" />

                        <ui:Button
                            Grid.Column="3"
                            Padding="12,6"
                            Appearance="Secondary"
                            Command="{Binding GoToUpdateDiaryCommand}"
                            Content="Update Existing Diary..."
                            IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}" />
                    </Grid>
                </Border>

                <Border
                    Padding="20"
                    Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="10">
                    <StackPanel>
                        <Grid Margin="0,0,0,12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBlock
                                Grid.Column="0"
                                FontSize="16"
                                FontWeight="SemiBold"
                                Text="Sessions" />
                            <CheckBox
                                Grid.Column="1"
                                VerticalAlignment="Center"
                                Content="Select all"
                                IsChecked="{Binding SelectAll, Mode=TwoWay}" />
                        </Grid>

                        <ItemsControl ItemsSource="{Binding Sessions}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="0,0,0,12">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="12" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>

                                        <CheckBox
                                            Grid.Column="0"
                                            VerticalAlignment="Center"
                                            IsChecked="{Binding IsSelected, Mode=TwoWay}" />

                                        <Border
                                            Grid.Column="2"
                                            Padding="12"
                                            BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                            BorderThickness="1"
                                            CornerRadius="8">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="16" />
                                                    <ColumnDefinition Width="Auto" />
                                                </Grid.ColumnDefinitions>

                                                <StackPanel Grid.Column="0">
                                                    <TextBlock
                                                        FontSize="14"
                                                        FontWeight="SemiBold"
                                                        Text="{Binding Name}" />
                                                    <TextBlock
                                                        FontSize="12"
                                                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                        Text="{Binding RepoAndRange}"
                                                        TextTrimming="CharacterEllipsis" />
                                                    <TextBlock
                                                        FontSize="12"
                                                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                        Text="{Binding RepoPath}"
                                                        TextTrimming="CharacterEllipsis" />
                                                    <TextBlock
                                                        Margin="0,2,0,0"
                                                        FontSize="12"
                                                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                        Text="{Binding CreatedAtDisplay}" />
                                                </StackPanel>

                                                <ui:Button
                                                    Grid.Column="2"
                                                    Padding="10,6"
                                                    HorizontalAlignment="Center"
                                                    VerticalAlignment="Center"
                                                    Appearance="Secondary"
                                                    Click="SessionExportMenuButton_Click"
                                                    Content="..."
                                                    Tag="{Binding DataContext, RelativeSource={RelativeSource AncestorType=Page}}"
                                                    ToolTip="Session export actions">
                                                    <ui:Button.ContextMenu>
                                                        <ContextMenu>
                                                            <MenuItem
                                                                Command="{Binding PlacementTarget.Tag.ExportSingleDiaryCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                                CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                                Header="Export diary" />
                                                            <MenuItem
                                                                Command="{Binding PlacementTarget.Tag.ExportSingleArchiveCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                                CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                                Header="Export archive" />
                                                            <MenuItem
                                                                Command="{Binding PlacementTarget.Tag.ExportSingleBothCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                                CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                                Header="Export both" />
                                                        </ContextMenu>
                                                    </ui:Button.ContextMenu>
                                                </ui:Button>
                                            </Grid>
                                        </Border>
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>
            </StackPanel>
        </DataTemplate>

        <DataTemplate x:Key="NewTargetTemplate">
            <StackPanel>
                <Border
                    Margin="0,0,0,16"
                    Padding="20"
                    Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="10">
                    <StackPanel>
                        <TextBlock
                            Margin="0,0,0,6"
                            FontSize="16"
                            FontWeight="SemiBold"
                            Text="Create New Export" />
                        <TextBlock
                            FontSize="12"
                            Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                            Text="Exports new managed diary and/or archive for the currently selected sessions." />

                        <Grid Margin="0,16,0,0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <StackPanel Grid.Row="0">
                                <TextBlock
                                    FontSize="12"
                                    Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                    Text="Output folder" />
                                <TextBlock
                                    FontSize="13"
                                    Text="{Binding OutputDirectory}"
                                    TextTrimming="CharacterEllipsis" />
                            </StackPanel>

                            <ui:Button
                                Grid.Row="1"
                                Margin="0,16,0,0"
                                Padding="10,6"
                                Appearance="Secondary"
                                Command="{Binding ChooseOutputDirectoryCommand}"
                                Content="Choose..."
                                IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}" />
                        </Grid>

                        <StackPanel Margin="0,12,0,0">
                            <TextBlock
                                FontSize="12"
                                Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                Text="Diary file name" />
                            <ui:TextBox
                                Margin="0,4,0,0"
                                PlaceholderText="DevDiary_YYYYMMDD_HHMMSS.md"
                                Text="{Binding DiaryFileName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                        </StackPanel>

                        <Grid Margin="0,16,0,0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="16" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <StackPanel Grid.Row="0" Orientation="Horizontal">
                                <CheckBox
                                    Margin="0,0,16,0"
                                    Content="Diary"
                                    IsChecked="{Binding ExportDiary, Mode=TwoWay}" />
                                <CheckBox Content="Archive" IsChecked="{Binding ExportArchive, Mode=TwoWay}" />
                            </StackPanel>

                            <Grid Grid.Row="2">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="50" />
                                    <ColumnDefinition Width="180" />
                                </Grid.ColumnDefinitions>

                                <TextBlock
                                    Grid.Column="0"
                                    VerticalAlignment="Center"
                                    Text="Format:" />
                                <ComboBox
                                    Grid.Column="2"
                                    SelectedValue="{Binding SelectedFormat}"
                                    SelectedValuePath="Tag">
                                    <ComboBoxItem Content="Markdown + JSON" Tag="{x:Static services:ExportFormat.MarkdownAndJson}" />
                                    <ComboBoxItem Content="Markdown only" Tag="{x:Static services:ExportFormat.MarkdownOnly}" />
                                    <ComboBoxItem Content="JSON only" Tag="{x:Static services:ExportFormat.JsonOnly}" />
                                </ComboBox>
                            </Grid>
                        </Grid>

                        <StackPanel Margin="0,16,0,0" Orientation="Horizontal">
                            <CheckBox
                                Margin="0,0,16,0"
                                Content="Hide repo paths in Markdown"
                                IsChecked="{Binding HideRepoPathsInMarkdown, Mode=TwoWay}" />
                            <CheckBox Content="Include placeholders" IsChecked="{Binding IncludePlaceholders, Mode=TwoWay}" />
                        </StackPanel>

                        <StackPanel
                            Margin="0,16,0,0"
                            HorizontalAlignment="Right"
                            Orientation="Horizontal">
                            <ui:Button
                                Margin="0,0,8,0"
                                Padding="12,6"
                                Appearance="Secondary"
                                Command="{Binding GoToHubCommand}"
                                Content="Back"
                                IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}" />
                            <ui:Button
                                Padding="12,6"
                                Appearance="Primary"
                                Command="{Binding ExportNewCommand}"
                                Content="Export"
                                IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}" />
                            <ui:Button
                                Margin="8,0,0,0"
                                Padding="12,6"
                                Appearance="Danger"
                                Command="{Binding CancelCommand}"
                                Content="Cancel"
                                IsEnabled="{Binding IsBusy}" />
                        </StackPanel>
                    </StackPanel>
                </Border>

                <StackPanel Margin="0,8,0,0" Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock
                        FontSize="12"
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                        Text="{Binding Status}" />
                    <TextBlock
                        FontSize="11"
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                        Text="{Binding RecoverActionText}"
                        Visibility="{Binding HasRecoverableIssue, Converter={StaticResource BooleanToVisibilityConverter}}" />
                    <TextBlock
                        FontSize="11"
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                        Text="{Binding ProgressCounterText}"
                        Visibility="{Binding HasProgressCounter, Converter={StaticResource BooleanToVisibilityConverter}}" />
                    <ProgressBar
                        Height="4"
                        Margin="0,6,0,0"
                        IsIndeterminate="{Binding IsProgressIndeterminate}"
                        Maximum="100"
                        Minimum="0"
                        Value="{Binding ProgressPercent}" />
                </StackPanel>
            </StackPanel>
        </DataTemplate>

        <DataTemplate x:Key="UpdateDiaryTemplate">
            <StackPanel>
                <Border
                    Margin="0,0,0,16"
                    Padding="20"
                    Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="10">
                    <StackPanel>
                        <TextBlock
                            Margin="0,0,0,6"
                            FontSize="16"
                            FontWeight="SemiBold"
                            Text="Update Existing Diary" />
                        <TextBlock
                            FontSize="12"
                            Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                            Text="Loads a diary file and updates DevChronicle-generated sections from the database." />

                        <Grid Margin="0,16,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock
                                    FontSize="12"
                                    Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                    Text="Diary file" />
                                <TextBlock
                                    FontSize="13"
                                    Text="{Binding DiaryPath}"
                                    TextTrimming="CharacterEllipsis" />
                            </StackPanel>

                            <ui:Button
                                Grid.Column="1"
                                Padding="10,6"
                                Appearance="Secondary"
                                Command="{Binding BrowseDiaryCommand}"
                                Content="Browse..."
                                IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}" />
                        </Grid>

                        <Border
                            Margin="0,16,0,0"
                            Padding="12"
                            Background="#1F2329"
                            CornerRadius="8">
                            <StackPanel>
                                <TextBlock
                                    FontSize="12"
                                    Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                    Text="Status" />
                                <TextBlock FontSize="13" Text="{Binding Status}" />
                                <TextBlock
                                    Margin="0,8,0,0"
                                    FontSize="12"
                                    Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                    Text="Bound sessions (managed diaries)" />
                                <ItemsControl ItemsSource="{Binding BoundSessionIds}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock FontSize="12" Text="{Binding StringFormat=Session ID: {0}}" />
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </Border>

                        <Border
                            Margin="0,16,0,0"
                            Padding="12"
                            Background="#1F2329"
                            CornerRadius="8"
                            Visibility="{Binding HasDiffPreview, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <StackPanel>
                                <TextBlock
                                    FontSize="12"
                                    Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                    Text="Diff preview" />
                                <TextBlock FontSize="13">
                                    <Run Text="New: " />
                                    <Run Text="{Binding CurrentDiff.New}" />
                                    <Run Text="   Updated: " />
                                    <Run Text="{Binding CurrentDiff.Updated}" />
                                    <Run Text="   Unchanged: " />
                                    <Run Text="{Binding CurrentDiff.Unchanged}" />
                                    <Run Text="   Extra: " />
                                    <Run Text="{Binding CurrentDiff.Extra}" />
                                </TextBlock>
                                <TextBlock
                                    Margin="0,6,0,0"
                                    FontSize="12"
                                    Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                    Text="If unmanaged, convert to managed before updating." />
                            </StackPanel>
                        </Border>

                        <Border
                            Margin="0,16,0,0"
                            Padding="12"
                            Background="#1F2329"
                            CornerRadius="8"
                            Visibility="{Binding IsDiaryUnmanaged, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <StackPanel>
                                <Grid Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <TextBlock
                                        Grid.Column="0"
                                        FontSize="12"
                                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                        Text="Sessions to bind (for conversion)" />
                                    <CheckBox
                                        Grid.Column="1"
                                        VerticalAlignment="Center"
                                        Content="Select all"
                                        IsChecked="{Binding SelectAll, Mode=TwoWay}" />
                                </Grid>

                                <TextBlock
                                    Margin="0,0,0,10"
                                    FontSize="12"
                                    Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                    Text="These sessions will populate the DevChronicle-managed section appended to the new file." />

                                <ItemsControl ItemsSource="{Binding Sessions}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Margin="0,0,0,8">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition Width="10" />
                                                    <ColumnDefinition Width="*" />
                                                </Grid.ColumnDefinitions>
                                                <CheckBox
                                                    Grid.Column="0"
                                                    VerticalAlignment="Center"
                                                    IsChecked="{Binding IsSelected, Mode=TwoWay}" />
                                                <StackPanel Grid.Column="2">
                                                    <TextBlock FontSize="13" Text="{Binding Name}" />
                                                    <TextBlock
                                                        FontSize="12"
                                                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                        Text="{Binding RepoAndRange}"
                                                        TextTrimming="CharacterEllipsis" />
                                                </StackPanel>
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </Border>

                        <StackPanel
                            Margin="0,16,0,0"
                            HorizontalAlignment="Right"
                            Orientation="Horizontal">
                            <ui:Button
                                Margin="0,0,8,0"
                                Padding="12,6"
                                Appearance="Secondary"
                                Command="{Binding GoToHubCommand}"
                                Content="Back"
                                IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}" />
                            <ui:Button
                                Margin="0,0,8,0"
                                Padding="12,6"
                                Appearance="Secondary"
                                Command="{Binding ConvertToManagedCommand}"
                                Content="Convert to managed..."
                                IsEnabled="{Binding CanConvertToManaged}" />
                            <ui:Button
                                Padding="12,6"
                                Appearance="Primary"
                                Command="{Binding ApplyDiaryUpdateCommand}"
                                Content="Apply Update"
                                IsEnabled="{Binding IsDiaryManaged}" />
                            <ui:Button
                                Margin="8,0,0,0"
                                Padding="12,6"
                                Appearance="Danger"
                                Command="{Binding CancelCommand}"
                                Content="Cancel"
                                IsEnabled="{Binding IsBusy}" />
                        </StackPanel>
                    </StackPanel>
                </Border>

                <StackPanel Margin="0,8,0,0" Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock
                        FontSize="12"
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                        Text="{Binding Status}" />
                    <TextBlock
                        FontSize="11"
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                        Text="{Binding RecoverActionText}"
                        Visibility="{Binding HasRecoverableIssue, Converter={StaticResource BooleanToVisibilityConverter}}" />
                    <TextBlock
                        FontSize="11"
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                        Text="{Binding ProgressCounterText}"
                        Visibility="{Binding HasProgressCounter, Converter={StaticResource BooleanToVisibilityConverter}}" />
                    <ProgressBar
                        Height="4"
                        Margin="0,6,0,0"
                        IsIndeterminate="{Binding IsProgressIndeterminate}"
                        Maximum="100"
                        Minimum="0"
                        Value="{Binding ProgressPercent}" />
                </StackPanel>
            </StackPanel>
        </DataTemplate>
    </Page.Resources>

    <ScrollViewer>
        <StackPanel Margin="56,24,56,24">
            <TextBlock
                Margin="0,0,0,6"
                FontSize="28"
                FontWeight="SemiBold"
                Text="Export" />
            <TextBlock
                Margin="0,0,0,20"
                FontSize="14"
                Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                Text="Create new exports or update an existing developer diary from the database." />

            <ContentControl Content="{Binding}">
                <ContentControl.Style>
                    <Style TargetType="ContentControl">
                        <Setter Property="ContentTemplate" Value="{StaticResource HubTemplate}" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Mode}" Value="{x:Static vm:ExportMode.NewTarget}">
                                <Setter Property="ContentTemplate" Value="{StaticResource NewTargetTemplate}" />
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Mode}" Value="{x:Static vm:ExportMode.UpdateDiary}">
                                <Setter Property="ContentTemplate" Value="{StaticResource UpdateDiaryTemplate}" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ContentControl.Style>
            </ContentControl>
        </StackPanel>
    </ScrollViewer>
</Page>
