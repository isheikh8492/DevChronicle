<Page x:Class="DevChronicle.Views.SettingsPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
      Title="Settings"
      Foreground="{DynamicResource TextFillColorPrimaryBrush}">

    <ScrollViewer>
        <StackPanel Margin="56,24,56,24">
            <TextBlock
                FontSize="28"
                FontWeight="SemiBold"
                Text="Settings"
                Margin="0,0,0,8"/>
            <TextBlock
                FontSize="14"
                Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                Text="Configure application settings and preferences."
                Margin="0,0,0,24"/>

            <ui:Card Margin="0,0,0,16">
                <StackPanel Margin="20">
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                        <ui:SymbolIcon Symbol="Key24" FontSize="20" Margin="0,0,12,0"/>
                        <TextBlock FontSize="16" FontWeight="Medium" Text="OpenAI API Configuration" VerticalAlignment="Center"/>
                    </StackPanel>
                    <TextBlock
                        FontSize="12"
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                        Text="API Key is stored securely in the database"
                        Margin="0,0,0,12"/>
                    <Grid Margin="0,0,0,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <ui:TextBox x:Name="OpenAiApiKeyBox"
                            Grid.Column="0"
                            PlaceholderText="Enter your OpenAI API key"
                            Text="{Binding DisplayedApiKey, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            Margin="0,0,8,0"
                            GotFocus="OpenAiApiKeyBox_GotFocus"
                            TextChanged="OpenAiApiKeyBox_TextChanged"/>
                        <ui:Button
                            Grid.Column="1"
                            Command="{Binding ToggleApiKeyVisibilityCommand}"
                            ToolTip="Show/Hide API Key"
                            Appearance="Secondary"
                            Padding="8">
                            <ui:SymbolIcon Symbol="{Binding IsApiKeyVisible, Converter={StaticResource BoolToEyeIconConverter}}"/>
                        </ui:Button>
                    </Grid>
                    <ui:Button
                        Content="Save API Key"
                        Icon="{ui:SymbolIcon Save24}"
                        Appearance="Primary"
                        Click="SaveApiKey_Click"
                        HorizontalAlignment="Left"/>

                    <TextBlock
                        FontSize="12"
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                        Text="Summarization model"
                        Margin="0,16,0,8"/>
                    <ComboBox
                        ItemsSource="{Binding AvailableSummarizationModels}"
                        SelectedItem="{Binding SelectedSummarizationModel, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                        MinWidth="220"
                        HorizontalAlignment="Left"/>
                </StackPanel>
            </ui:Card>

            <ui:Card Margin="0,0,0,16">
                <StackPanel Margin="20">
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                        <ui:SymbolIcon Symbol="Folder24" FontSize="20" Margin="0,0,12,0"/>
                        <TextBlock FontSize="16" FontWeight="Medium" Text="Export Defaults" VerticalAlignment="Center"/>
                    </StackPanel>
                    <TextBlock
                        FontSize="12"
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                        Text="Default output folder used by quick exports and as the initial export destination."
                        Margin="0,0,0,12"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <ui:TextBox x:Name="ExportDefaultDirectoryBox"
                                    Grid.Column="0"
                                    Text="{Binding DefaultExportDirectory, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                    Margin="0,0,8,0"/>
                        <ui:Button Grid.Column="1"
                                   Content="Browse"
                                   Icon="{ui:SymbolIcon Folder24}"
                                   Click="BrowseExportDirectory_Click"/>
                    </Grid>
                </StackPanel>
            </ui:Card>

            <ui:Card Margin="0,0,0,16">
                <StackPanel Margin="20">
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                        <ui:SymbolIcon Symbol="Settings24" FontSize="20" Margin="0,0,12,0"/>
                        <TextBlock FontSize="16" FontWeight="Medium" Text="Summarization Limits" VerticalAlignment="Center"/>
                    </StackPanel>
                    <TextBlock
                        FontSize="12"
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                        Text="These control output length and the continuation behavior when a response hits the token limit."
                        Margin="0,0,0,12"/>

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="16"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <Border Grid.Column="0"
                                Padding="10"
                                CornerRadius="6"
                                BorderThickness="1"
                                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                Background="{DynamicResource CardBackgroundFillColorDefaultBrush}">
                            <StackPanel>
                                <TextBlock Text="Max tokens per call" FontSize="12" Foreground="{DynamicResource TextFillColorSecondaryBrush}" Margin="0,0,0,6"/>
                                <ui:NumberBox Value="{Binding SummarizationMaxCompletionTokensPerCall, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                              Minimum="256"
                                              Maximum="8000"
                                              SpinButtonPlacementMode="Inline"/>
                            </StackPanel>
                        </Border>

                        <Border Grid.Column="2"
                                Padding="10"
                                CornerRadius="6"
                                BorderThickness="1"
                                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                Background="{DynamicResource CardBackgroundFillColorDefaultBrush}">
                            <StackPanel>
                                <TextBlock Text="Max total bullets/day" FontSize="12" Foreground="{DynamicResource TextFillColorSecondaryBrush}" Margin="0,0,0,6"/>
                                <ui:NumberBox Value="{Binding SummarizationMaxTotalBulletsPerDay, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                              Minimum="1"
                                              Maximum="200"
                                              SpinButtonPlacementMode="Inline"/>
                            </StackPanel>
                        </Border>
                    </Grid>
                </StackPanel>
            </ui:Card>

            <ui:Card Margin="0,0,0,16">
                <StackPanel Margin="20">
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                        <ui:SymbolIcon Symbol="TextT24" FontSize="20" Margin="0,0,12,0"/>
                        <TextBlock FontSize="16" FontWeight="Medium" Text="Summarization Master Prompt" VerticalAlignment="Center"/>
                    </StackPanel>
                    <TextBlock
                        FontSize="12"
                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                        Text="This prompt is used as the developer message for OpenAI summarization."
                        Margin="0,0,0,12"/>
                    <ui:TextBox
                        AcceptsReturn="True"
                        TextWrapping="Wrap"
                        VerticalScrollBarVisibility="Auto"
                        Height="140"
                        MaxHeight="200"
                        Text="{Binding MasterPromptText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                        PlaceholderText="Enter your master prompt"
                        Margin="0,0,0,12"/>
                    <ui:Button
                        Content="Save Prompt"
                        Icon="{ui:SymbolIcon Save24}"
                        Appearance="Primary"
                        Click="SaveMasterPrompt_Click"
                        HorizontalAlignment="Left"/>
                </StackPanel>
            </ui:Card>

            <ui:Card Margin="0,0,0,16">
                <StackPanel Margin="20">
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                        <ui:SymbolIcon Symbol="Settings24" FontSize="20" Margin="0,0,12,0"/>
                        <TextBlock FontSize="16" FontWeight="Medium" Text="Processing Options" VerticalAlignment="Center"/>
                    </StackPanel>

                    <Border Margin="0,0,0,12"
                            Padding="10"
                            CornerRadius="6"
                            BorderThickness="1"
                            BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                            Background="{DynamicResource CardBackgroundFillColorDefaultBrush}">
                        <StackPanel>
                            <CheckBox Content="Include merge commits"
                                      Margin="0,0,0,6"
                                      FontSize="14"
                                      IsChecked="{Binding IncludeMerges, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                            <CheckBox Content="Include diffs in summarization"
                                      FontSize="14"
                                      IsChecked="{Binding IncludeDiffs, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                        </StackPanel>
                    </Border>

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="16"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <Border Grid.Column="0"
                                Padding="10"
                                CornerRadius="6"
                                BorderThickness="1"
                                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                Background="{DynamicResource CardBackgroundFillColorDefaultBrush}">
                            <StackPanel>
                                <TextBlock Text="Window size (days)" FontSize="12" Foreground="{DynamicResource TextFillColorSecondaryBrush}" Margin="0,0,0,6"/>
                                <ui:NumberBox Value="{Binding WindowSizeDays, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                              Minimum="1"
                                              Maximum="90"
                                              SpinButtonPlacementMode="Inline"/>
                            </StackPanel>
                        </Border>

                        <Border Grid.Column="2"
                                Padding="10"
                                CornerRadius="6"
                                BorderThickness="1"
                                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                Background="{DynamicResource CardBackgroundFillColorDefaultBrush}">
                            <StackPanel>
                                <TextBlock Text="Max bullets per day" FontSize="12" Foreground="{DynamicResource TextFillColorSecondaryBrush}" Margin="0,0,0,6"/>
                                <ui:NumberBox Value="{Binding MaxBulletsPerDay, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                              Minimum="1"
                                              Maximum="60"
                                              SpinButtonPlacementMode="Inline"/>
                            </StackPanel>
                        </Border>
                    </Grid>

                    <Grid Margin="0,16,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="16"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <Border Grid.Column="0"
                                Padding="10"
                                CornerRadius="6"
                                BorderThickness="1"
                                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                Background="{DynamicResource CardBackgroundFillColorDefaultBrush}">
                            <StackPanel>
                                <TextBlock Text="Overlap days" FontSize="12" Foreground="{DynamicResource TextFillColorSecondaryBrush}" Margin="0,0,0,6"/>
                                <ui:NumberBox Value="{Binding OverlapDays, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                              Minimum="0"
                                              Maximum="14"
                                              SpinButtonPlacementMode="Inline"/>
                            </StackPanel>
                        </Border>

                        <Border Grid.Column="2"
                                Padding="10"
                                CornerRadius="6"
                                BorderThickness="1"
                                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                Background="{DynamicResource CardBackgroundFillColorDefaultBrush}">
                            <StackPanel>
                                <TextBlock Text="Backfill order" FontSize="12" Foreground="{DynamicResource TextFillColorSecondaryBrush}" Margin="0,0,0,6"/>
                                <ComboBox SelectedValuePath="Tag"
                                          SelectedValue="{Binding BackfillOrder, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                    <ComboBoxItem Content="Oldest first" Tag="OldestFirst"/>
                                    <ComboBoxItem Content="Newest first" Tag="NewestFirst"/>
                                    <ComboBoxItem Content="Fill gaps first" Tag="GappedFirst"/>
                                </ComboBox>
                            </StackPanel>
                        </Border>
                    </Grid>

                    <Border Margin="0,12,0,0"
                            Padding="10"
                            CornerRadius="6"
                            BorderThickness="1"
                            BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                            Background="{DynamicResource CardBackgroundFillColorDefaultBrush}">
                        <StackPanel>
                            <CheckBox Content="Fill gaps first"
                                      FontSize="14"
                                      IsChecked="{Binding FillGapsFirst, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </ui:Card>
        </StackPanel>
    </ScrollViewer>
</Page>
